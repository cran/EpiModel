<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />



<title>Working With Custom Attributes and Summary Statistics</title>

<script src="data:application/javascript;base64,Ly8gUGFuZG9jIDIuOSBhZGRzIGF0dHJpYnV0ZXMgb24gYm90aCBoZWFkZXIgYW5kIGRpdi4gV2UgcmVtb3ZlIHRoZSBmb3JtZXIgKHRvCi8vIGJlIGNvbXBhdGlibGUgd2l0aCB0aGUgYmVoYXZpb3Igb2YgUGFuZG9jIDwgMi44KS4KZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignRE9NQ29udGVudExvYWRlZCcsIGZ1bmN0aW9uKGUpIHsKICB2YXIgaHMgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCJkaXYuc2VjdGlvbltjbGFzcyo9J2xldmVsJ10gPiA6Zmlyc3QtY2hpbGQiKTsKICB2YXIgaSwgaCwgYTsKICBmb3IgKGkgPSAwOyBpIDwgaHMubGVuZ3RoOyBpKyspIHsKICAgIGggPSBoc1tpXTsKICAgIGlmICghL15oWzEtNl0kL2kudGVzdChoLnRhZ05hbWUpKSBjb250aW51ZTsgIC8vIGl0IHNob3VsZCBiZSBhIGhlYWRlciBoMS1oNgogICAgYSA9IGguYXR0cmlidXRlczsKICAgIHdoaWxlIChhLmxlbmd0aCA+IDApIGgucmVtb3ZlQXR0cmlidXRlKGFbMF0ubmFtZSk7CiAgfQp9KTsK"></script>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>


<style type="text/css">
  code {
    white-space: pre;
  }
  .sourceCode {
    overflow: visible;
  }
</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>




<link rel="stylesheet" href="data:text/css,body%20%7B%0Abackground%2Dcolor%3A%20%23fff%3B%0Amargin%3A%201em%20auto%3B%0Amax%2Dwidth%3A%20700px%3B%0Aoverflow%3A%20visible%3B%0Apadding%2Dleft%3A%202em%3B%0Apadding%2Dright%3A%202em%3B%0Afont%2Dfamily%3A%20%22Open%20Sans%22%2C%20%22Helvetica%20Neue%22%2C%20Helvetica%2C%20Arial%2C%20sans%2Dserif%3B%0Afont%2Dsize%3A%2014px%3B%0Aline%2Dheight%3A%201%2E35%3B%0A%7D%0A%23TOC%20%7B%0Aclear%3A%20both%3B%0Amargin%3A%200%200%2010px%2010px%3B%0Apadding%3A%204px%3B%0Awidth%3A%20400px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Aborder%2Dradius%3A%205px%3B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Afont%2Dsize%3A%2013px%3B%0Aline%2Dheight%3A%201%2E3%3B%0A%7D%0A%23TOC%20%2Etoctitle%20%7B%0Afont%2Dweight%3A%20bold%3B%0Afont%2Dsize%3A%2015px%3B%0Amargin%2Dleft%3A%205px%3B%0A%7D%0A%23TOC%20ul%20%7B%0Apadding%2Dleft%3A%2040px%3B%0Amargin%2Dleft%3A%20%2D1%2E5em%3B%0Amargin%2Dtop%3A%205px%3B%0Amargin%2Dbottom%3A%205px%3B%0A%7D%0A%23TOC%20ul%20ul%20%7B%0Amargin%2Dleft%3A%20%2D2em%3B%0A%7D%0A%23TOC%20li%20%7B%0Aline%2Dheight%3A%2016px%3B%0A%7D%0Atable%20%7B%0Amargin%3A%201em%20auto%3B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dcolor%3A%20%23DDDDDD%3B%0Aborder%2Dstyle%3A%20outset%3B%0Aborder%2Dcollapse%3A%20collapse%3B%0A%7D%0Atable%20th%20%7B%0Aborder%2Dwidth%3A%202px%3B%0Apadding%3A%205px%3B%0Aborder%2Dstyle%3A%20inset%3B%0A%7D%0Atable%20td%20%7B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dstyle%3A%20inset%3B%0Aline%2Dheight%3A%2018px%3B%0Apadding%3A%205px%205px%3B%0A%7D%0Atable%2C%20table%20th%2C%20table%20td%20%7B%0Aborder%2Dleft%2Dstyle%3A%20none%3B%0Aborder%2Dright%2Dstyle%3A%20none%3B%0A%7D%0Atable%20thead%2C%20table%20tr%2Eeven%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Ap%20%7B%0Amargin%3A%200%2E5em%200%3B%0A%7D%0Ablockquote%20%7B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Apadding%3A%200%2E25em%200%2E75em%3B%0A%7D%0Ahr%20%7B%0Aborder%2Dstyle%3A%20solid%3B%0Aborder%3A%20none%3B%0Aborder%2Dtop%3A%201px%20solid%20%23777%3B%0Amargin%3A%2028px%200%3B%0A%7D%0Adl%20%7B%0Amargin%2Dleft%3A%200%3B%0A%7D%0Adl%20dd%20%7B%0Amargin%2Dbottom%3A%2013px%3B%0Amargin%2Dleft%3A%2013px%3B%0A%7D%0Adl%20dt%20%7B%0Afont%2Dweight%3A%20bold%3B%0A%7D%0Aul%20%7B%0Amargin%2Dtop%3A%200%3B%0A%7D%0Aul%20li%20%7B%0Alist%2Dstyle%3A%20circle%20outside%3B%0A%7D%0Aul%20ul%20%7B%0Amargin%2Dbottom%3A%200%3B%0A%7D%0Apre%2C%20code%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0Aborder%2Dradius%3A%203px%3B%0Acolor%3A%20%23333%3B%0Awhite%2Dspace%3A%20pre%2Dwrap%3B%20%0A%7D%0Apre%20%7B%0Aborder%2Dradius%3A%203px%3B%0Amargin%3A%205px%200px%2010px%200px%3B%0Apadding%3A%2010px%3B%0A%7D%0Apre%3Anot%28%5Bclass%5D%29%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Acode%20%7B%0Afont%2Dfamily%3A%20Consolas%2C%20Monaco%2C%20%27Courier%20New%27%2C%20monospace%3B%0Afont%2Dsize%3A%2085%25%3B%0A%7D%0Ap%20%3E%20code%2C%20li%20%3E%20code%20%7B%0Apadding%3A%202px%200px%3B%0A%7D%0Adiv%2Efigure%20%7B%0Atext%2Dalign%3A%20center%3B%0A%7D%0Aimg%20%7B%0Abackground%2Dcolor%3A%20%23FFFFFF%3B%0Apadding%3A%202px%3B%0Aborder%3A%201px%20solid%20%23DDDDDD%3B%0Aborder%2Dradius%3A%203px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Amargin%3A%200%205px%3B%0A%7D%0Ah1%20%7B%0Amargin%2Dtop%3A%200%3B%0Afont%2Dsize%3A%2035px%3B%0Aline%2Dheight%3A%2040px%3B%0A%7D%0Ah2%20%7B%0Aborder%2Dbottom%3A%204px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Apadding%2Dbottom%3A%202px%3B%0Afont%2Dsize%3A%20145%25%3B%0A%7D%0Ah3%20%7B%0Aborder%2Dbottom%3A%202px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Afont%2Dsize%3A%20120%25%3B%0A%7D%0Ah4%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23f7f7f7%3B%0Amargin%2Dleft%3A%208px%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Ah5%2C%20h6%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23ccc%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Aa%20%7B%0Acolor%3A%20%230033dd%3B%0Atext%2Ddecoration%3A%20none%3B%0A%7D%0Aa%3Ahover%20%7B%0Acolor%3A%20%236666ff%3B%20%7D%0Aa%3Avisited%20%7B%0Acolor%3A%20%23800080%3B%20%7D%0Aa%3Avisited%3Ahover%20%7B%0Acolor%3A%20%23BB00BB%3B%20%7D%0Aa%5Bhref%5E%3D%22http%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0Aa%5Bhref%5E%3D%22https%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0A%0Acode%20%3E%20span%2Ekw%20%7B%20color%3A%20%23555%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Edt%20%7B%20color%3A%20%23902000%3B%20%7D%20%0Acode%20%3E%20span%2Edv%20%7B%20color%3A%20%2340a070%3B%20%7D%20%0Acode%20%3E%20span%2Ebn%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Efl%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Ech%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Est%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Eco%20%7B%20color%3A%20%23888888%3B%20font%2Dstyle%3A%20italic%3B%20%7D%20%0Acode%20%3E%20span%2Eot%20%7B%20color%3A%20%23007020%3B%20%7D%20%0Acode%20%3E%20span%2Eal%20%7B%20color%3A%20%23ff0000%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Efu%20%7B%20color%3A%20%23900%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Eer%20%7B%20color%3A%20%23a61717%3B%20background%2Dcolor%3A%20%23e3d2d2%3B%20%7D%20%0A" type="text/css" />




</head>

<body>




<h1 class="title toc-ignore">Working With Custom Attributes and Summary Statistics</h1>



<div id="introduction" class="section level2">
<h2>Introduction</h2>
<p>This vignette discusses some recent updates in <code>EpiModel</code> on working with attributes and summary statistics within the stochastic network model class. This material is oriented towards custom models with extension modules and functions. Further details are provided in the “New Network Models with EpiModel” section of <a href="https://www.epimodel.org/tut.html">the EpiModel tutorials</a>.</p>
<p>In network simulations with <code>netsim</code>, we store all data in the <em>Master List Object</em> (referred to as <code>dat</code>). In this vignette we will discuss with three types of data on <code>dat</code>:</p>
<ul>
<li><em>Current Nodal Attributes</em></li>
<li><em>Historical Nodal Attributes</em></li>
<li><em>Epidemic Trackers</em></li>
</ul>
</div>
<div id="current-nodal-attributes" class="section level2">
<h2>Current Nodal Attributes</h2>
<p><em>Attributes</em> are characteristics of the nodes (e.g., persons) in the model at the current time-step. By default, every node has a <code>unique_id</code> and an <code>active</code> <em>attribute</em> used to track each node, as well as three attributes used in the epidemic modules: <code>status</code> for disease status, <code>entrTime</code> for the time the node entered the population, and <code>exitTime</code> for the time the node left the population. Other attributes can be added of any name and value, like <code>age</code>, but must be stored as a scalar values.</p>
<p>We work with <em>attribute vectors</em> that are all of the same size of the number of nodes in the model. In the <em>attribute vectors</em>, a node is identified by its <em>Positional ID</em> or <code>posit_id</code> (i.e., the position in vector). The default <em>attribute</em> <code>unique_id</code> created for each node gives a unique identification number allowing us to refer to nodes no longer in the model. Deaths or other forms of exit from the network disrupt the positional ID but do not impact the unique ID.</p>
<div id="working-with-attributes" class="section level3">
<h3>Working With Attributes</h3>
<div id="accessing-attributes" class="section level4">
<h4>Accessing Attributes</h4>
<p>The <code>EpiModel::get_attr</code> function will extract the vector of a given <em>attribute</em>. In its simplest form, we can pull a complete <em>attribute vector</em> from <code>dat</code> like so:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>active <span class="ot">&lt;-</span> EpiModel<span class="sc">::</span><span class="fu">get_attr</span>(dat, <span class="st">&quot;active&quot;</span>)</span></code></pre></div>
<p>The above call will pull from <code>dat</code> the <code>active</code> <em>attribute</em> for all nodes. <code>active</code> is a vector of size <em>current number of nodes</em>. With values being either 1 or 0 depending on whether a node is active or not.</p>
<p>Trying to extract an <em>attribute</em> that does not exist will cause <code>EpiModel::get_attr</code> to throw an error.</p>
</div>
<div id="modifying-attributes" class="section level4">
<h4>Modifying Attributes</h4>
<p>In custom extension modules, we usually want to modify some of the <em>attributes</em>. Below is a minimal module that increments the age of all the nodes by 1.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>aging_module <span class="ot">&lt;-</span> <span class="cf">function</span>(dat, at) {</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extract current attribute</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  age <span class="ot">&lt;-</span> EpiModel<span class="sc">::</span><span class="fu">get_attr</span>(dat, <span class="st">&quot;age&quot;</span>)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Aging process</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>  new_age <span class="ot">&lt;-</span> age <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Output updated attributes</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>  dat <span class="ot">&lt;-</span> EpiModel<span class="sc">::</span><span class="fu">set_attr</span>(dat, <span class="st">&quot;age&quot;</span>, new_age)</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(dat)</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Let’s break down this very simple yet perfectly valid module.</p>
<ol style="list-style-type: decimal">
<li>Pull the <code>age</code> <em>attribute vector</em> as we did in the previous section.</li>
<li>Create a vector <code>new_age</code> incrementing all ages by one.</li>
<li>Update the <code>dat</code> object with the <code>EpiModel::set_attr</code> function.</li>
<li>Return the Updated <code>dat</code> object.</li>
</ol>
<p>We can see that <code>EpiModel::set_attr</code> takes as arguments:</p>
<ul>
<li>The <code>dat</code> object to update.</li>
<li>The name of the attribute vector of interest (here “age”).</li>
<li>The new values for this vector (here <code>new_age</code>).</li>
</ul>
<p>When using <code>EpiModel::set_attr</code>, there are several things to note:</p>
<ul>
<li>The function does not modify the <code>dat</code> object, it merely returns a modified version of it to be assigned back to <code>dat</code>. (Nicely, this does not cause performance issues due to the way R handles shallow copies since version 3.1)</li>
<li>If <code>new_age</code> size is not equal to the number of nodes in the network, the function will throw an error.</li>
</ul>
</div>
<div id="summary" class="section level4">
<h4>Summary</h4>
<p>The above example describes the recommended way to work with attribute:</p>
<ol style="list-style-type: decimal">
<li>Extract the <em>attributes</em> into local vectors.</li>
<li>Modify the local vectors with some dynamic process (like aging).</li>
<li>Update the <code>dat</code> object with the revised local vectors.</li>
<li>Return the <code>dat</code> object at the end of the function.</li>
</ol>
<p>These functions have other arguments that are described in the documentation: see <code>help(&quot;net-accessor&quot;, package = &quot;EpiModel&quot;)</code> for further details.</p>
</div>
</div>
</div>
<div id="historical-nodal-attributes" class="section level2">
<h2>Historical Nodal Attributes</h2>
<p>The <em>Attributes</em> described above refer to the state of <strong>each node</strong> in the network <strong>at the current time-step</strong>. However, it is sometimes useful to track of what happened to nodes over time. Because saving the full history of the <em>attributes</em> would consume too much memory and is rarely necessary for full-scale research models, EpiModel offers a way to record specific <em>attribute</em> for specific nodes at different time-steps. These may be useful for diagnostic purposes (e.g., to see that a dynamic process is coded correctly) or for tracking a limited set of individual-level outcomes for further analysis.</p>
<p>The <em>Attribute History</em> is an efficient collection of recorded attributes at different time-steps. EpiModel has functions to record these elements and to access them in a convenient manner once the <code>netsim</code> simulation is complete.</p>
<div id="working-with-attribute-histories" class="section level3">
<h3>Working with Attribute Histories</h3>
<div id="recording-attribute-histories" class="section level4">
<h4>Recording Attribute Histories</h4>
<p>The following is a module that records the viral load of infected nodes every 10 time steps. We assume that this module is part of a model that defines and updates two <em>attributes</em> over time:</p>
<ul>
<li><code>status</code> with possible values being “infected” or “susceptible”.</li>
<li><code>viral_load</code> as a continuous number for “infected” nodes and <code>NA</code> otherwise.</li>
</ul>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>viral_load_logger_module <span class="ot">&lt;-</span> <span class="cf">function</span>(dat, at) {</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Run every 10 time steps</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (at <span class="sc">%%</span> <span class="dv">10</span> <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Attributes</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    status <span class="ot">&lt;-</span> EpiModel<span class="sc">::</span><span class="fu">get_attr</span>(dat, <span class="st">&quot;status&quot;</span>)</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>    viral_load <span class="ot">&lt;-</span> EpiModel<span class="sc">::</span><span class="fu">get_attr</span>(dat, <span class="st">&quot;viral_load&quot;</span>)</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>    infected <span class="ot">&lt;-</span> <span class="fu">which</span>(status <span class="sc">==</span> <span class="st">&quot;infected&quot;</span>)</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>    dat <span class="ot">&lt;-</span> EpiModel<span class="sc">::</span><span class="fu">record_attr_history</span>(</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>      dat, at,</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;viral_load&quot;</span>,</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>      infected,</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>      viral_load[infected]</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Output</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(dat)</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>The steps in the code are as follows:</p>
<ol style="list-style-type: decimal">
<li>Check that the current time step is a multiple of ten. If yes, go to step 2, otherwise skip to step 5.</li>
<li>Pull the 2 <em>attribute vectors</em> of interest (“status” and “viral_load”).</li>
<li>Store in <code>infected</code> the <code>posit_id</code>s of the infected nodes.</li>
<li>Record the <code>viral_load</code> of <code>infected</code> nodes at time <code>at</code> under the label “viral_load”.</li>
<li>Return the <code>dat</code> object.</li>
</ol>
<p><code>EpiModel::record_attr_history</code> takes five arguments:</p>
<ol style="list-style-type: decimal">
<li>The <code>dat</code> object.</li>
<li>The time step to be associated with the recording (here <code>at</code>, the current time-step).</li>
<li>The label to be used for the attribute (here “viral_load”).</li>
<li>A vector of <code>posit_id</code>s referring to the nodes of interest (here <code>infected</code>).</li>
<li>The values to be recorded for those IDs (here <code>viral_load[infected]</code>)</li>
</ol>
<p>Note that <code>EpiModel::record_attr_history</code> requires a set of <code>posit_id</code>s. Internally, the function will convert them to <code>unique_id</code>s so the <em>Attribute History</em> will not be affected by nodes entering or leaving the population over time.</p>
<p>When recording some attribute histories, one must ensure that we record as many values as there are <code>posit_id</code>s. Otherwise, the function will throw an error. It however possible to use only one value for that attribute even if we record a value for multiple nodes. This last situation actually uses less RAM. In any case, we would want to record attribute histories sparingly as the storage can be large, especially for open population models with many nodes that run over many time steps.</p>
</div>
<div id="accessing-the-attribute-histories" class="section level4">
<h4>Accessing the Attribute Histories</h4>
<p>The <em>Attribute History</em> is meant to be accessed once the <code>netsim</code> simulation is complete. At that point, we can use the <code>EpiModel::get_attr_history</code> function to access the histories that we have recorded, like so:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>sim <span class="ot">&lt;-</span> <span class="fu">netsim</span>(est, param, init, control)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>attr_history <span class="ot">&lt;-</span> EpiModel<span class="sc">::</span><span class="fu">get_attr_history</span>(sim)</span></code></pre></div>
<p>The <code>attr_history</code> object is a list of <code>data.frame</code>s. One for each attribute history that was recorded (we use this flexible list structure because each history may be of different dimension). Assume that we were running two simulations, using the module defined above and another one (not shown) recording when a node switched from infected to recovered.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">get_attr_history</span>(sim)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="co"># $viral_load</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="co">#    sim step attribute    uids values</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="co"># 1  1   10   viral_load   1001   2000</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="co"># 2  1   10   viral_load   1002   1878</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="co"># 3  1   20   viral_load   1001   1500</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="co"># 4  1   20   viral_load   1002    300</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="co"># 5  2   10   viral_load    401   2500</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a><span class="co"># 6  2   10   viral_load    402   1378</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a><span class="co"># 7  2   20   viral_load    401   1200</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a><span class="co"># 8  2   20   viral_load    402    100</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a><span class="co"># ...</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a><span class="co"># $switch_status</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a><span class="co">#    sim step attribute      uids     values</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a><span class="co"># 1  1   22   switch_status  1001   infected</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a><span class="co"># 2  1   64   switch_status  1002   infected</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a><span class="co"># 3  1  110   switch_status  1001  recovered</span></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a><span class="co"># 4  1  220   switch_status  1002  recovered</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a><span class="co"># 5  2    7   switch_status   401   infected</span></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a><span class="co"># 6  2   15   switch_status   402   infected</span></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a><span class="co"># 7  2   20   switch_status   401  recovered</span></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a><span class="co"># 8  2  120   switch_status   402  recovered</span></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a><span class="co"># ...</span></span></code></pre></div>
<p>We would get a named list of two <code>data.frame</code>’s:</p>
<ul>
<li>“viral_load” with the <code>value</code> column being the viral loads.</li>
<li>“switch_status” with the <code>value</code> column being whether the node became “infected” or “recovered” at the given time-step.</li>
</ul>
</div>
</div>
</div>
<div id="epidemic-trackers" class="section level2">
<h2>Epidemic Trackers</h2>
<p>The next type of data stored in <code>dat</code> is called an <em>Epidemic Tracker</em>. This refers to some summary information about the <em>population</em> at a specific time step. This information is created and stored for <strong>each time step</strong>; therefore epidemic trackers are historical summary statistics.</p>
<p>One example of an <em>Epidemic Trackers</em> is <code>num</code>, present in any model, which stores the size of the population at each time step.</p>
<div id="working-with-epidemic-trackers-in-modules" class="section level3">
<h3>Working With Epidemic Trackers in Modules</h3>
<p>Inside a module, <em>Epidemic Trackers</em> are accessed and modified with the functions <code>EpiModel::get_epi</code> and <code>EpiModel::set_epi</code>. Below is an updated new version of our <code>aging_module</code> above with the addition of epidemic trackers.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>aging_track_module <span class="ot">&lt;-</span> <span class="cf">function</span>(dat, at) {</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Attributes</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  age <span class="ot">&lt;-</span> EpiModel<span class="sc">::</span><span class="fu">get_attr</span>(dat, <span class="st">&quot;age&quot;</span>)</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Aging process </span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>  new_age <span class="ot">&lt;-</span> age <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate summary statistics</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>  mean_age <span class="ot">&lt;-</span> <span class="fu">mean</span>(new_age)</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>  prev_mean_age <span class="ot">&lt;-</span> EpiModel<span class="sc">::</span><span class="fu">get_epi</span>(dat, at <span class="sc">-</span> <span class="dv">1</span>, <span class="st">&quot;mean_age&quot;</span>)</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>  age_change <span class="ot">&lt;-</span> mean_age <span class="sc">-</span> prev_mean_age</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Update nodal attributes</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>  dat <span class="ot">&lt;-</span> EpiModel<span class="sc">::</span><span class="fu">set_attr</span>(dat, <span class="st">&quot;age&quot;</span>, new_age)</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Update epidemic trackers</span></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>  dat <span class="ot">&lt;-</span> <span class="fu">set_epi</span>(dat, <span class="st">&quot;mean_age&quot;</span>, at, mean_age)</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>  dat <span class="ot">&lt;-</span> <span class="fu">set_epi</span>(dat, <span class="st">&quot;age_change&quot;</span>, at, age_change)</span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(dat)</span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>In this new module, in addition to incrementing the age of each node by one, we also record two values as <em>Epidemic Trackers</em>: the mean age of the population and the change in mean age compared to the previous step (we could have calculated the latter after the simulation was complete with <code>mutate_epi</code>, but here we do it on the fly to demonstrate <code>get_epi</code>).</p>
<p>We extract the mean age at the previous time step using <code>EpiModel::get_epi</code> and set the second argument as <code>at - 1</code>. After all the calculations are complete, we store <code>mean_age</code> and <code>age_change</code> in <code>dat</code> using <code>EpiModel::set_epi</code>.</p>
<ul>
<li>Similarly to <code>EpiModel::set_attr</code>, <code>dat</code> is not modified directly and need to be assigned back to itself. Also, the value we store must be a scalar.</li>
<li>Trying to access an <em>Epidemic Trackers</em> that do not exist results in an error.</li>
</ul>
</div>
<div id="accessing-epidemic-trackers-after-a-simulation" class="section level3">
<h3>Accessing Epidemic Trackers After a Simulation</h3>
<p><em>Epidemic Trackers</em> are usually the main quantities of interest after a simulation has completed. We access them simply by calling <code>as.data.frame</code> on a <code>netsim</code> object or by using the plot or summary functions within by EpiModel. Note also that you can perform derived summary statistic calculations after a <code>netsim</code> call is complete with <code>EpiModel::mutate_epi</code>.</p>
</div>
<div id="custom-epidemic-trackers" class="section level3">
<h3>Custom Epidemic Trackers</h3>
<p>It can be useful to create small <em>Epidemic Trackers</em> outside of the modules and use them only when we need them. EpiModel contains an optional module called <code>EpiModel::trackers.net</code> allowing such functionality.</p>
<div id="writing-tracker-functions" class="section level4">
<h4>Writing Tracker Functions</h4>
<p>We call a <em>tracker function</em> a <code>function</code> that takes <code>dat</code> and <code>at</code> as arguments and outputs a scalar value. Every <em>tracker function</em> is run by the <code>trackers.net</code> module at each time step.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>epi_s_num <span class="ot">&lt;-</span> <span class="cf">function</span>(dat, at) {</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  needed_attributes <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;status&quot;</span>)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  output <span class="ot">&lt;-</span> <span class="fu">with</span>(<span class="fu">get_attr_list</span>(dat, needed_attributes), {</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    out <span class="ot">&lt;-</span> <span class="fu">sum</span>(status <span class="sc">==</span> <span class="st">&quot;susceptible&quot;</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    out</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(output)</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>The <code>epi_s_num</code> function defined above is a <em>tracker function</em>. It calculates at each time step the number of <em>susceptible</em> nodes in the network.</p>
<p>The next example is a <em>tracker function</em> that calculates the proportion of the population infected at each time step. Let’s look what each element does:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>epi_prop_infected <span class="ot">&lt;-</span> <span class="cf">function</span>(dat, at) {</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># we need two attributes for our calculation: `status` and `active`</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  needed_attributes <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;status&quot;</span>, <span class="st">&quot;active&quot;</span>)</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># we use `with` to simplify code</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>  output <span class="ot">&lt;-</span> <span class="fu">with</span>(EpiModel<span class="sc">::</span><span class="fu">get_attr_list</span>(dat, needed_attributes), {</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>    pop <span class="ot">&lt;-</span> active <span class="sc">==</span> <span class="dv">1</span>             <span class="co"># we only look at active nodes</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>    cond <span class="ot">&lt;-</span> status <span class="sc">==</span> <span class="st">&quot;infected&quot;</span>   <span class="co"># which are infected </span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># how many are `infected` among the `active`</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>    out <span class="ot">&lt;-</span> <span class="fu">sum</span>(cond <span class="sc">&amp;</span> pop, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">/</span> <span class="fu">sum</span>(pop, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>    out</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(output)</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>We recommend that you write your <em>tracker functions</em> using this format:</p>
<ol style="list-style-type: decimal">
<li>Define a <code>needed_attributes</code> variable containing a vector of attribute names: in this example: “status” and “active”.</li>
<li>Use <code>with</code> and <code>EpiModel::get_attr_list(dat, needed_attributes)</code> to work in an environment with only the objects you need. This helps clarify what the tracker does and simplify any debugging. We save the result of this call into <code>output</code>.</li>
<li>Define <code>out</code> as the calculated outcome inside <code>with</code>. This <em>must</em> be a scalar. This is the last element evaluated by the <code>with</code> expression.</li>
<li><code>return(output)</code>, what was calculated inside the <code>with</code> construct.</li>
</ol>
</div>
<div id="using-a-trackers.net-module" class="section level4">
<h4>Using A <code>trackers.net</code> Module</h4>
<p>This functionality is part of an optional module provided by <code>EpiModel</code>, <code>trackers.net</code>. This module must be enabled in <code>control.net</code>. The <em>tracker functions</em> themselves must be declared as a named list in <code>control.net</code>: <code>tracker.list</code>. Let’s make a simple SI epidemic model with some added trackers:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the `tracker.list` list</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>some.trackers <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">prop_infected =</span> epi_prop_infected,</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">s_num         =</span> epi_s_num</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>control <span class="ot">&lt;-</span> EpiModel<span class="sc">::</span><span class="fu">control.net</span>(</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">type =</span> <span class="cn">NULL</span>, <span class="co"># must be NULL as we use custom extension modules</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">nsims =</span> <span class="dv">1</span>,</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">nsteps =</span> <span class="dv">50</span>,</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">verbose =</span> <span class="cn">FALSE</span>,</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">infection.FUN =</span> EpiModel<span class="sc">::</span>infection.net,</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">trackers.FUN =</span> EpiModel<span class="sc">::</span>trackers.net,</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">tracker.list =</span> some.trackers</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>param <span class="ot">&lt;-</span> EpiModel<span class="sc">::</span><span class="fu">param.net</span>(</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">inf.prob =</span> <span class="fl">0.3</span>,</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">act.rate =</span> <span class="fl">0.1</span></span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>nw <span class="ot">&lt;-</span> <span class="fu">network_initialize</span>(<span class="at">n =</span> <span class="dv">50</span>)</span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>nw <span class="ot">&lt;-</span> <span class="fu">set_vertex_attribute</span>(nw, <span class="st">&quot;race&quot;</span>, <span class="fu">rbinom</span>(<span class="dv">50</span>, <span class="dv">1</span>, <span class="fl">0.5</span>))</span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>est <span class="ot">&lt;-</span> EpiModel<span class="sc">::</span><span class="fu">netest</span>(</span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>  nw,</span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>  <span class="at">formation =</span> <span class="sc">~</span>edges,</span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>  <span class="at">target.stats =</span> <span class="dv">25</span>,</span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a>  <span class="at">coef.diss =</span> <span class="fu">dissolution_coefs</span>(<span class="sc">~</span><span class="fu">offset</span>(edges), <span class="dv">10</span>, <span class="dv">0</span>),</span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>  <span class="at">verbose =</span> <span class="cn">FALSE</span></span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Starting maximum pseudolikelihood estimation (MPLE):</span></span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Evaluating the predictor and response matrix.</span></span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Maximizing the pseudolikelihood.</span></span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Finished MPLE.</span></span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Stopping at the initial estimate.</span></span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a>init <span class="ot">&lt;-</span> EpiModel<span class="sc">::</span><span class="fu">init.net</span>(<span class="at">i.num =</span> <span class="dv">10</span>)</span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a>sim <span class="ot">&lt;-</span> EpiModel<span class="sc">::</span><span class="fu">netsim</span>(est, param, init, control)</span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(sim)</span>
<span id="cb9-41"><a href="#cb9-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-42"><a href="#cb9-42" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(<span class="fu">tail</span>(d, <span class="at">n =</span> <span class="dv">15</span>))</span></code></pre></div>
<table>
<thead>
<tr class="header">
<th align="left"></th>
<th align="right">sim</th>
<th align="right">time</th>
<th align="right">s.num</th>
<th align="right">i.num</th>
<th align="right">num</th>
<th align="right">prop_infected</th>
<th align="right">s_num</th>
<th align="right">si.flow</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">36</td>
<td align="right">1</td>
<td align="right">36</td>
<td align="right">30</td>
<td align="right">20</td>
<td align="right">50</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left">37</td>
<td align="right">1</td>
<td align="right">37</td>
<td align="right">30</td>
<td align="right">20</td>
<td align="right">50</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="left">38</td>
<td align="right">1</td>
<td align="right">38</td>
<td align="right">30</td>
<td align="right">20</td>
<td align="right">50</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left">39</td>
<td align="right">1</td>
<td align="right">39</td>
<td align="right">30</td>
<td align="right">20</td>
<td align="right">50</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="left">40</td>
<td align="right">1</td>
<td align="right">40</td>
<td align="right">30</td>
<td align="right">20</td>
<td align="right">50</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left">41</td>
<td align="right">1</td>
<td align="right">41</td>
<td align="right">30</td>
<td align="right">20</td>
<td align="right">50</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="left">42</td>
<td align="right">1</td>
<td align="right">42</td>
<td align="right">30</td>
<td align="right">20</td>
<td align="right">50</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left">43</td>
<td align="right">1</td>
<td align="right">43</td>
<td align="right">30</td>
<td align="right">20</td>
<td align="right">50</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="left">44</td>
<td align="right">1</td>
<td align="right">44</td>
<td align="right">30</td>
<td align="right">20</td>
<td align="right">50</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left">45</td>
<td align="right">1</td>
<td align="right">45</td>
<td align="right">30</td>
<td align="right">20</td>
<td align="right">50</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="left">46</td>
<td align="right">1</td>
<td align="right">46</td>
<td align="right">30</td>
<td align="right">20</td>
<td align="right">50</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left">47</td>
<td align="right">1</td>
<td align="right">47</td>
<td align="right">29</td>
<td align="right">21</td>
<td align="right">50</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="left">48</td>
<td align="right">1</td>
<td align="right">48</td>
<td align="right">29</td>
<td align="right">21</td>
<td align="right">50</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left">49</td>
<td align="right">1</td>
<td align="right">49</td>
<td align="right">29</td>
<td align="right">21</td>
<td align="right">50</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="left">50</td>
<td align="right">1</td>
<td align="right">50</td>
<td align="right">29</td>
<td align="right">21</td>
<td align="right">50</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
</tr>
</tbody>
</table>
<p>Each function must be named in the <code>tracker.list</code> list. The name given there will be used to identify the <em>tracker function</em> in the <code>epi</code> list and will be the name of the corresponding column of the <code>data.frame</code> produced by <code>as.data.frame(sim)</code> where <code>sim</code> is a <code>netsim</code> object.</p>
<p><em>Note</em>: in the <code>some.trackers</code> list, we put <code>epi_prop_infected</code> and <code>epi_s_num</code> without parentheses at the end. This is because we store the <code>function</code> and not the result of calling the function.</p>
<p>This is the minimal <code>control.net</code> to enable the module. Usually, in research-level models, we will want to add other extension modules. See the “Advanced Extension Models” section in the <a href="http://www.epimodel.org/tut.html">EpiModel Tutorials</a> site for further examples.</p>
<p><strong>Important</strong>: when enabling the <code>trackers.net</code> module, one must pay particular attention to the order the modules are run. It is recommended to have the <code>trackers.net</code> module run last so the tracked values will reflect the state of the model at the end of the time step.</p>
</div>
</div>
</div>
<div id="record-any-object-advanced-debugging" class="section level2">
<h2>Record Any Object (Advanced Debugging)</h2>
<p>When working with complex research-level models, we sometimes want to inspect the state of an object without stopping the simulation. The function <code>EpiModel::record_raw_object</code> allows the user to save any object during the simulation.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>introspect_module <span class="ot">&lt;-</span> <span class="cf">function</span>(dat, at) {</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Attributes</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  age <span class="ot">&lt;-</span> <span class="fu">get_attr</span>(dat, <span class="st">&quot;age&quot;</span>)</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">mean</span>(age, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">&gt;</span> <span class="dv">50</span>) {</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    obj <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>        <span class="at">age =</span> age,</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>        <span class="at">status =</span> EpiModel<span class="sc">::</span><span class="fu">get_attr</span>(dat, <span class="st">&quot;status&quot;</span>)</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>    dat <span class="ot">&lt;-</span> EpiModel<span class="sc">::</span><span class="fu">record_raw_object</span>(dat, at, <span class="st">&quot;old pop&quot;</span>, obj)</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(dat)</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>In this module, we look at the age of the population and if the mean age is more than 50, we create a <code>data.frame</code> called <code>obj</code> containing the <code>age</code> and <code>status</code> <em>attribute vectors</em> and store it in a <em>Raw Record</em>.</p>
<p>This <em>Raw Record</em> can be accessed in the final <code>netsim</code> object for debugging purposes.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>sim <span class="ot">&lt;-</span> <span class="fu">netsim</span>(est, param, init, control)</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>sim[[<span class="st">&quot;raw.records&quot;</span>]][[<span class="dv">1</span>]]</span></code></pre></div>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
